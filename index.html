<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AirGuard Pro | Monitoring Real-Time</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #38bdf8; --bg: #0f172a; --card: rgba(30, 41, 59, 0.7); 
            --safe: #4ade80; --warn: #fbbf24; --danger: #f87171; --offline: #64748b;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: white; margin: 0; padding: 0; }
        
        /* Header */
        .header { position: sticky; top: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); padding: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .logo { font-weight: 800; font-size: 1.2rem; letter-spacing: -1px; }
        .indicator { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; font-weight: 600; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--offline); transition: 0.3s; }
        .dot.active { background: var(--safe); box-shadow: 0 0 12px var(--safe); }

        .container { padding: 20px; max-width: 900px; margin: auto; padding-bottom: 100px; }
        
        /* Grid Kartu */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .card { background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); position: relative; overflow: hidden; transition: 0.4s; }
        .card-label { font-size: 0.7rem; font-weight: 600; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; }
        .card-value { font-size: 2.2rem; font-weight: 800; margin: 8px 0; }
        .card-unit { font-size: 0.8rem; opacity: 0.5; font-weight: 400; }
        .status-tag { font-size: 0.65rem; font-weight: 800; padding: 5px 12px; border-radius: 10px; background: rgba(255,255,255,0.05); display: inline-block; }

        /* Chart Area */
        .chart-box { background: var(--card); border-radius: 28px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); height: 380px; }
        
        /* Animasi Bahaya */
        .danger-mode { animation: glow-danger 1.5s infinite; border-color: var(--danger); }
        @keyframes glow-danger { 0%, 100% { box-shadow: 0 0 5px rgba(248,113,113,0.2); } 50% { box-shadow: 0 0 20px rgba(248,113,113,0.4); } }

        /* Navigasi Bawah */
        .nav-bar { position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(20px); height: 70px; border-radius: 25px; display: flex; justify-content: space-around; align-items: center; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .nav-item { text-align: center; cursor: pointer; opacity: 0.6; transition: 0.3s; }
        .nav-item.active { opacity: 1; color: var(--primary); }
        .btn-export { background: var(--primary); color: var(--bg); width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-top: -45px; border: 5px solid var(--bg); font-size: 1.5rem; }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo">AIR<span style="color:var(--primary)">GUARD</span> PRO</div>
        <div class="indicator">
            <div id="status-dot" class="dot"></div>
            <span id="status-text">CONNECTING</span>
        </div>
    </header>

    <main class="container">
        <div class="grid">
            <div class="card" id="pm-card">
                <div class="card-label">PM2.5 Dust</div>
                <div class="card-value" id="pm-val">0</div>
                <div class="card-unit">Âµg/mÂ³</div>
                <div class="status-tag" id="pm-status">OFFLINE</div>
            </div>
            
            <div class="card" id="co2-card">
                <div class="card-label">Carbon Dioxide</div>
                <div class="card-value" id="co2-val">0</div>
                <div class="card-unit">PPM Level</div>
                <div class="status-tag" id="co2-status">OFFLINE</div>
            </div>
        </div>

        <div class="chart-box">
            <canvas id="airChart"></canvas>
        </div>
    </main>

    <nav class="nav-bar">
        <div class="nav-item active">ðŸ“Š<br><small>Live</small></div>
        <div class="btn-export" onclick="exportExcel()">ðŸ“¥</div>
        <div class="nav-item" onclick="location.reload()">ðŸ”„<br><small>Refresh</small></div>
    </nav>

<script>
    // 1. KONFIGURASI FIREBASE
    const firebaseConfig = {
        databaseURL: "https://air-quality-monitoring-97365-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let chart;
    let excelData = [];
    let timeoutTimer;

    // 2. INISIALISASI CHART (Dual Axis)
    function initChart() {
        const ctx = document.getElementById('airChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'PM2.5', borderColor: '#fbbf24', data: [], tension: 0.4, yAxisID: 'y', pointRadius: 0 },
                    { label: 'CO2', borderColor: '#38bdf8', data: [], tension: 0.4, yAxisID: 'y1', pointRadius: 0 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { position: 'left', ticks: {color: '#64748b'}, title: {display: true, text: 'Dust'} },
                    y1: { position: 'right', grid: {display: false}, ticks: {color: '#64748b'}, title: {display: true, text: 'CO2'} }
                },
                plugins: { legend: { labels: { color: 'white', font: {family: 'Plus Jakarta Sans'} } } }
            }
        });
    }

    // 3. FUNGSI LOGIKA AMAN/WASPADA/BERBAHAYA
    function getCategorization(pm) {
        if (pm === 0) return { label: "OFFLINE", color: "var(--offline)", bg: "rgba(100,116,139,0.1)", pulse: false };
        if (pm <= 55.4) return { label: "AMAN", color: "var(--safe)", bg: "rgba(74,222,128,0.1)", pulse: false };
        if (pm <= 150.4) return { label: "WASPADA", color: "var(--warn)", bg: "rgba(251,191,36,0.1)", pulse: false };
        return { label: "BERBAHAYA", color: "var(--danger)", bg: "rgba(248,113,113,0.15)", pulse: true };
    }

    // 4. FUNGSI RESET (SAFE-ZERO)
    function setOffline() {
        document.getElementById('status-dot').className = 'dot';
        document.getElementById('status-text').innerText = 'OFFLINE';
        updateUI({ pm25: 0, co2: 0 }, false);
    }

    // 5. UPDATE TAMPILAN
    function updateUI(data, isOnline) {
        const pm = parseFloat(data.pm25) || 0;
        const co2 = parseFloat(data.co2) || 0;
        const cat = getCategorization(pm);

        // Update PM2.5 Card
        const pmCard = document.getElementById('pm-card');
        document.getElementById('pm-val').innerText = pm.toFixed(1);
        document.getElementById('pm-val').style.color = cat.color;
        document.getElementById('pm-status').innerText = cat.label;
        document.getElementById('pm-status').style.color = cat.color;
        pmCard.style.background = cat.bg;
        pmCard.className = cat.pulse ? "card danger-mode" : "card";

        // Update CO2 Card
        document.getElementById('co2-val').innerText = Math.round(co2);
        document.getElementById('co2-status').innerText = (co2 === 0) ? "OFFLINE" : (co2 > 1000 ? "BURUK" : "NORMAL");
        document.getElementById('co2-status').style.color = (co2 > 1000) ? "var(--danger)" : "var(--safe)";

        if (isOnline && pm > 0) {
            document.getElementById('status-dot').className = 'dot active';
            document.getElementById('status-text').innerText = 'LIVE';
            
            // Push ke Chart
            const time = new Date().toLocaleTimeString();
            chart.data.labels.push(time);
            chart.data.datasets[0].data.push(pm);
            chart.data.datasets[1].data.push(co2);
            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets.forEach(d => d.data.shift());
            }
            chart.update();
            
            // Simpan untuk Excel
            excelData.push({ Waktu: new Date().toLocaleString(), PM25: pm, CO2: co2, Status: cat.label });
        }
    }

    // 6. FIREBASE LISTENER
    db.ref('live_data').on('value', (snap) => {
        clearTimeout(timeoutTimer);
        if (snap.exists()) {
            updateUI(snap.val(), true);
            // Jika data tidak update dalam 12 detik, anggap offline
            timeoutTimer = setTimeout(setOffline, 12000);
        } else {
            setOffline();
        }
    });

    function exportExcel() {
        if(excelData.length === 0) return alert("Belum ada data untuk diekspor!");
        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "AirQualityData");
        XLSX.writeFile(wb, "Laporan_AirGuard.xlsx");
    }

    initChart();
</script>
</body>
</html>